#!/usr/bin/env bash

echo "------ HOOK START - BUILD -------"

# Get git tag
GIT_TAG="$(git describe --always --tags)"

# Build image with arguments
docker image build \
  --build-arg VERSION="$GIT_TAG" \
  --build-arg VCS_URL="$(git config --get remote.origin.url)" \
  --build-arg VCS_REF="$(git rev-parse --short HEAD)" \
  --build-arg BUILD_DATE="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
  -t "$IMAGE_NAME" .

# If tag matches semantic version, break it down into components
if [[ "$GIT_TAG" != v* ]]; then
  echo 'Version number does not match semantic version'
  exit
fi

semver="${GIT_TAG#v}"
semver="${semver%%-*}"
semver=( ${semver//./ } )

major="${semver[0]}"
minor="${semver[1]}"
patch="${semver[2]}"


docker image tag "$IMAGE_NAME" "${DOCKER_REPO}:${major}.${minor}.${patch}"
docker image tag "$IMAGE_NAME" "${DOCKER_REPO}:${major}.${minor}"
docker image tag "$IMAGE_NAME" "${DOCKER_REPO}:${major}"

echo "------ HOOK END - BUILD -------"
